[build]
  command = "bash ./netlify-deploy.sh"
  publish = ".next"
  # Let @netlify/plugin-nextjs handle the build output automatically

[build.environment]
  # Align with production environment
  NODE_VERSION = "20.19.1"
  # Provide headroom for Next build while respecting CI memory budget
  NODE_OPTIONS = "--max-old-space-size=1024"
  NETLIFY_LINT = "false"
  # Configure specific Next.js flags for Netlify
  NEXT_USE_NETLIFY_EDGE = "false"
  # Disable Next.js telemetry in CI/build
  NEXT_TELEMETRY_DISABLED = "1"
  # Safe build-time toggles (non-secrets)
  ANALYTICS_ENABLED = "true"
  API_BASE_URL = "https://posalpro-mvp2.windsurf.build/api"
  # Force Prisma to use library (native) engines on Netlify (disable wasm/dataproxy)
  PRISMA_CLI_QUERY_ENGINE_TYPE = "library"
  PRISMA_CLIENT_ENGINE_TYPE = "library"
  PRISMA_GENERATE_DATAPROXY = "false"
  PRISMA_CLI_BINARY_TARGETS = "debian-openssl-3.0.x"

# Explicit production-context overrides (non-secrets only)
[context.production.environment]
  # Node & Next config
  NODE_VERSION = "20.19.1"
  NODE_OPTIONS = "--max-old-space-size=1024"
  NEXT_USE_NETLIFY_EDGE = "false"
  NEXT_TELEMETRY_DISABLED = "1"

  # Safe toggles
  ANALYTICS_ENABLED = "true"
  API_BASE_URL = "https://posalpro-mvp2.windsurf.build/api"

  # Prisma engine settings
  PRISMA_CLI_QUERY_ENGINE_TYPE = "library"
  PRISMA_CLIENT_ENGINE_TYPE = "library"
  PRISMA_GENERATE_DATAPROXY = "false"
  PRISMA_CLI_BINARY_TARGETS = "debian-openssl-3.0.x"

  # Secrets required in Netlify Dashboard (do NOT commit values here):
  # DATABASE_URL = "<set in Netlify UI>"
  # DIRECT_URL = "<set in Netlify UI>"
  # NEXTAUTH_URL = "https://posalpro-mvp2.windsurf.build"
  # NEXTAUTH_SECRET = "<set in Netlify UI>"
  # JWT_SECRET = "<set in Netlify UI>"
  # CSRF_SECRET = "<set in Netlify UI>"
  # NETLIFY_DATABASE_URL = "<optional: set in Netlify UI>"
  # NETLIFY_DATABASE_URL_UNPOOLED = "<optional: set in Netlify UI>"

[[plugins]]
  package = "@netlify/plugin-nextjs"

# API routes are handled automatically by @netlify/plugin-nextjs

# Set proper content type for API responses
[[headers]]
  for = "/api/*"
  [headers.values]
    Content-Type = "application/json; charset=utf-8"
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers = "Origin, X-Requested-With, Content-Type, Accept, Authorization"
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"

# Optimize static files
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Functions are managed by @netlify/plugin-nextjs
[functions]
  included_files = ["schema.prisma"]

# Database initialization hook
[dev]
  command = "npm run dev:smart"

# Add specific image optimization handling
[[redirects]]
  from = "/_next/image"
  to = "/.netlify/images"
  status = 200

# âœ… CRITICAL: Essential catch-all redirect for Next.js App Router
# This MUST be the LAST redirect rule - do not add any redirects after this
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
