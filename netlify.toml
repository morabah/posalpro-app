[build]
  # âœ… CRITICAL: Build from source using production environment variables
  # Ensure Prisma Client is freshly generated for Linux with native engine (not Data Proxy)
  command = "rm -rf node_modules/.prisma && PRISMA_GENERATE_DATAPROXY=false npx prisma generate --schema=./prisma/schema.production.prisma && npm run build"
  publish = ".next"

  # Ensure clean build - remove any cached artifacts
  ignore = "git diff --quiet HEAD~1 HEAD -- .next/"

[build.environment]
  # ðŸš¨ IMPORTANT: Sensitive variables removed from VCS.
  # Set the following in Netlify UI (Site settings > Environment variables):
  #   DIRECT_URL, DATABASE_URL, NEXTAUTH_SECRET, JWT_SECRET, CSRF_SECRET,
  #   SESSION_ENCRYPTION_KEY, API_KEY, REDIS_URL, NEXT_PUBLIC_APP_URL, NEXTAUTH_URL

  # Align with production environment (non-secrets)
  NODE_VERSION = "22"
  # Increase memory for TypeScript compilation (2GB)
  NODE_OPTIONS = "--max-old-space-size=2048"
  NETLIFY_LINT = "false"
  # Configure specific Next.js flags for Netlify
  NEXT_USE_NETLIFY_EDGE = "false"
  # Disable edge functions to avoid require() issues
  NETLIFY_EDGE_FUNCTIONS = "false"
  # Disable Next.js telemetry in CI/build
  NEXT_TELEMETRY_DISABLED = "1"
  # Safe build-time toggles (non-secrets)
  ANALYTICS_ENABLED = "true"
  # Prefer configuring API_BASE_URL via Netlify UI; this is safe but optional
  # API_BASE_URL = "https://posalpro.netlify.app/api"

  # Prisma engine settings (non-secrets) - force native engines, not Data Proxy
  PRISMA_CLI_QUERY_ENGINE_TYPE = "library"
  PRISMA_CLIENT_ENGINE_TYPE = "library"
  PRISMA_GENERATE_DATAPROXY = "false"
  PRISMA_CLI_BINARY_TARGETS = "debian-openssl-3.0.x"

  # Use production schema explicitly
  PRISMA_SCHEMA = "prisma/schema.production.prisma"

  # Build toggles (non-secrets)
  # Do NOT skip Prisma generate in Netlify â€” we must regenerate for linux
  PRISMA_GENERATE_SKIP_DOWNLOAD = "false"
  SKIP_PRISMA_GENERATE = "false"
  NETLIFY_BUILD_TIME = "true"
  BUILD_MODE = "static"

# Explicit production-context overrides (non-secrets only)
[context.production.environment]
  # Node & Next config
  NODE_VERSION = "22"
  NODE_OPTIONS = "--max-old-space-size=2048"
  NEXT_USE_NETLIFY_EDGE = "false"
  NEXT_TELEMETRY_DISABLED = "1"

  # Safe toggles
  ANALYTICS_ENABLED = "true"
  API_BASE_URL = "https://posalpro.netlify.app/api"

  # Prisma engine settings
  PRISMA_CLI_QUERY_ENGINE_TYPE = "library"
  PRISMA_CLIENT_ENGINE_TYPE = "library"
  PRISMA_GENERATE_DATAPROXY = "false"
  PRISMA_CLI_BINARY_TARGETS = "debian-openssl-3.0.x"
  PRISMA_SCHEMA = "prisma/schema.production.prisma"

[[plugins]]
  package = "@netlify/plugin-nextjs"

# API routes are handled automatically by @netlify/plugin-nextjs

# Set proper content type for API responses
[[headers]]
  for = "/api/*"
  [headers.values]
    Content-Type = "application/json; charset=utf-8"
    # CORS is handled dynamically in Next.js middleware with an origin allowlist.
    # Remove static wildcard CORS headers to avoid conflicts.
    Cache-Control = "no-cache, no-store, must-revalidate"
    Pragma = "no-cache"
    Expires = "0"

# Optimize static files
[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Functions are managed by @netlify/plugin-nextjs
[functions]
  included_files = ["schema.prisma"]
  # Avoid forcing large deps into every function bundle
  # Let the Next.js server handler bundle only what it actually imports.

[functions.pdf]
  # Bundle Puppeteer/Chromium only for the dedicated PDF function
  node_bundler = "esbuild"
  external_node_modules = ["puppeteer-core", "@sparticuz/chromium"]

# Database initialization hook
[dev]
  command = "npm run dev:smart"

# Add specific image optimization handling
[[redirects]]
  from = "/_next/image"
  to = "/.netlify/images"
  status = 200

# âœ… CRITICAL: Essential catch-all redirect for Next.js App Router
# This MUST be the LAST redirect rule - do not add any redirects after this
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
