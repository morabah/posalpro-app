name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CI: true
  NODE_ENV: test
  NEXT_TELEMETRY_DISABLED: 1
  DATABASE_URL: sqlite://memory
  USE_REDIS: 'false'

jobs:
  # ğŸ” Security & Type Safety Checks
  security-and-types:
    name: 'ğŸ”’ Security & Type Checks'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ” TypeScript Type Check
        run: npm run type-check

      - name: ğŸ›¡ï¸ Security Vulnerability Scan
        run: npm audit --audit-level high
        continue-on-error: true

      - name: ğŸ”’ Dependency Security Check
        run: |
          npm audit --json | jq -e '.vulnerabilities.high or .vulnerabilities.critical' && exit 1 || echo "âœ… No high/critical vulnerabilities found"

      - name: ğŸ” CodeQL Security Scan
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
        continue-on-error: true

      - name: ğŸ” Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        continue-on-error: true

      - name: ğŸ›¡ï¸ Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: ğŸ“¤ Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: ğŸ“‹ Schema Validation
        run: npm run db:validate

      - name: ğŸ—ï¸ Build Verification
        run: npm run build

      - name: ğŸ“Š Bundle Analysis
        run: npm run ci:bundle
        continue-on-error: true

  # ğŸ¯ Code Quality & Linting
  quality:
    name: 'âœ¨ Code Quality'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ¨ Code Formatting Check
        run: npm run format:check

      - name: ğŸ” Linting
        run: npm run lint

      - name: ğŸ“Š Bundle Budget Check
        run: npm run ci:bundle
        continue-on-error: true

      - name: ğŸ” Duplicate Detection
        run: npm run audit:duplicates

      - name: ğŸ—ï¸ Architecture Validation
        run: npm run audit:patterns
        continue-on-error: true

  # ğŸ§ª Testing Suite
  test:
    name: 'ğŸ§ª Tests'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ—„ï¸ Setup Database
        run: |
          npm run db:push
          npm run db:seed
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: ğŸ§ª Unit Tests
        run: npm run test:ci:unit

      - name: ğŸ”’ Security Tests
        run: npm run test:security

      - name: â™¿ Accessibility Tests
        run: npm run test:accessibility

      - name: ğŸ” Critical Gaps Tests
        run: npm run test:critical-gaps

      - name: ğŸš€ API Routes Tests
        run: npm run test:api-routes

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ğŸ—ï¸ Build & Deploy Checks
  build:
    name: 'ğŸ—ï¸ Build & Deploy'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Production Build
        run: npm run build

      - name: ğŸ“¦ Bundle Analysis
        run: npm run analyze
        continue-on-error: true

      - name: ğŸš€ Build Size Check
        run: |
          BUNDLE_SIZE=$(du -sh .next | cut -f1)
          echo "ğŸ“¦ Bundle size: $BUNDLE_SIZE"
          # Warn if bundle is too large
          if [[ $(du -s .next | cut -f1) -gt 100000 ]]; then
            echo "âš ï¸ Bundle size is large, consider optimization"
          fi

      - name: ğŸ“ Type Check Build
        run: npm run type-check

  # ğŸ” Integration Tests
  integration:
    name: 'ğŸ”— Integration Tests'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ—„ï¸ Setup Database
        run: |
          npm run db:push
          npm run db:seed
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db

      - name: ğŸ”— Integration Tests
        run: npm run test:integration

      - name: ğŸ¯ Real World Tests
        run: npm run test:real-world
        continue-on-error: true

      - name: ğŸ¨ Mobile Tests
        run: npm run test:mobile

  # ğŸ“Š Performance Monitoring
  performance:
    name: 'âš¡ Performance'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build for Performance Testing
        run: npm run build

      - name: âš¡ Performance Tests
        run: npm run test:performance
        continue-on-error: true

      - name: ğŸ“Š Bundle Budget Check
        run: npm run ci:bundle
        continue-on-error: true

  # ğŸ¯ Final Quality Gate
  quality-gate:
    name: 'ğŸ¯ Quality Gate'
    runs-on: ubuntu-latest
    needs: [security-and-types, quality, test, build, integration]
    if: always()
    steps:
      - name: Quality Gate Check
        run: |
          if [[ "${{ needs.security-and-types.result }}" != "success" ]]; then
            echo "âŒ Security & Type checks failed"
            exit 1
          fi

          if [[ "${{ needs.quality.result }}" != "success" ]]; then
            echo "âŒ Code quality checks failed"
            exit 1
          fi

          if [[ "${{ needs.test.result }}" != "success" ]]; then
            echo "âŒ Test suite failed"
            exit 1
          fi

          if [[ "${{ needs.build.result }}" != "success" ]]; then
            echo "âŒ Build verification failed"
            exit 1
          fi

          if [[ "${{ needs.integration.result }}" != "success" ]]; then
            echo "âŒ Integration tests failed"
            exit 1
          fi

          echo "ğŸ‰ All quality gates passed!"
